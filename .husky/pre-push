#!/bin/sh

# If SKIP_PRE_PUSH is set, skip this hook (prevents infinite loop)
if [ "$SKIP_PRE_PUSH" = "true" ]; then
  exit 0
fi

echo "🔍 Checking if /frontend has changed..."

while read local_ref local_sha remote_ref remote_sha
do
  # Detect changes in frontend folder between commits being pushed
  changes=$(git diff --name-only "$remote_sha" "$local_sha" -- frontend/)

  if [ -n "$changes" ]; then
    echo "📦 Changes detected in /frontend:"
    echo "$changes"
    echo "⚙️  Running Bun build..."

    cd frontend || {
      echo "❌ Could not find /frontend folder."
      exit 1
    }

    bun run build || {
      echo "❌ Build failed. Push aborted."
      exit 1
    }

    echo "✅ Build succeeded."

    # Go back to repo root to commit build output
    cd ..

    git add frontend/dist
    git commit -m "chore: auto-commit build output from pre-push hook" || {
      echo "ℹ️  No changes to commit."
    }

    # Push without triggering this hook again
    SKIP_PRE_PUSH=true git push
  else
    echo "✅ No changes in /frontend. Skipping build."
  fi
done
